<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İsim Şehir Hayvan - Oda Sistemi</title>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Indie+Flower&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { background-color: #d1d1d1; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Indie Flower', cursive; font-weight: bold; }
        .paper { background: #fff; background-image: linear-gradient(#919191 1px, transparent 1px), linear-gradient(90deg, #ffadad 2px, transparent 2px); background-size: 100% 35px, 100% 100%; background-position: 0 0, 50px 0; width: 95%; max-width: 900px; min-height: 600px; padding: 50px 40px 50px 80px; box-shadow: 15px 15px 30px rgba(0,0,0,0.3); position: relative; }
        
        h1 { font-size: 45px; margin-bottom: 20px; text-decoration: underline; color: #2c3e50; }
        label { font-size: 24px; font-weight: bold; color: #333; }
        input[type="text"], input[type="password"] { background: transparent; border: none; border-bottom: 3px solid #2980b9; font-family: 'Caveat', cursive; font-size: 28px; font-weight: bold; color: #1a1a1a; outline: none; margin-bottom: 10px; }
        
        #harf-alani { position: absolute; top: 15px; right: 35px; font-size: 75px; color: #d35400; border: 4px solid #d35400; border-radius: 50%; width: 110px; height: 110px; display: flex; align-items: center; justify-content: center; transform: rotate(5deg); }
        #sayac { font-size: 35px; color: #c0392b; font-weight: bold; margin-bottom: 10px; }

        .btn { background-color: #e67e22; color: white; border: none; padding: 15px 30px; font-family: 'Indie Flower', cursive; font-weight: bold; font-size: 22px; cursor: pointer; border-radius: 5px; margin: 10px 5px; box-shadow: 3px 3px 0px #a35d1a; }
        .btn:active { transform: translateY(2px); box-shadow: 1px 1px 0px #a35d1a; }
        .btn-green { background-color: #27ae60; box-shadow: 3px 3px 0px #1e8449; }

        .screen { display: none; }
        .active-screen { display: block; }

        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; margin: 20px 0; font-size: 22px; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 30px; margin-top: 30px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 24px; margin-top: 20px; }
        th { border-bottom: 3px solid #333; text-align: left; }
        td { border-bottom: 1px dashed #777; padding: 10px 0; }
    </style>
</head>
<body>
    <div class="paper">
        <div id="login-screen" class="screen active-screen">
            <h1>Hoş Geldiniz</h1>
            <input type="text" id="room-input" placeholder="Oda Adı"><br>
            <input type="password" id="pass-input" placeholder="Şifre"><br>
            <button class="btn" onclick="odaOlustur()">Oyun Oluştur</button>
            <button class="btn btn-green" onclick="odaKatil()">Oyuna Katıl</button>
        </div>

        <div id="lobby-screen" class="screen">
            <h1>Oda: <span id="display-room"></span></h1>
            <div id="host-controls">
                <h3>Kategorileri Belirle (Sadece Host):</h3>
                <div class="checkbox-group" id="cat-list"></div>
                <button class="btn btn-green" onclick="oyunuBaslat()">OYUNU BAŞLAT</button>
            </div>
            <div id="guest-wait" style="display:none;">
                <h3>Oyun sahibinin başlatması bekleniyor...</h3>
                <div id="guest-cat-display"></div>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div id="sayac" style="display:none;">SÜRE AZALIYOR!</div>
            <div id="harf-alani">?</div>
            <div id="input-area" class="input-grid"></div>
            <button id="bitir-btn" class="btn" onclick="bitirSinyali()">KALEMLERİ BIRAK!</button>
        </div>

        <div id="result-screen" class="screen">
            <h1>Sonuçlar</h1>
            <div id="table-area"></div>
            <button class="btn" onclick="lobiyeDon()">Yeni Tur</button>
        </div>
    </div>

    <script>
        var socket = io();
        let myRoom = "";
        let isHost = false;
        let activeCats = [];
        const allCats = ["İsim", "Şehir", "Hayvan", "Bitki", "Ülke", "Ünlü", "Dizi/Film", "Şarkı", "Yemek", "Kıyafet"];

        // Ekran Değiştirme
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
        }

        // Oda İşlemleri
        function odaOlustur() {
            myRoom = document.getElementById('room-input').value;
            let pass = document.getElementById('pass-input').value;
            socket.emit('oda_olustur', {oda: myRoom, sifre: pass});
        }

        function odaKatil() {
            myRoom = document.getElementById('room-input').value;
            let pass = document.getElementById('pass-input').value;
            socket.emit('oda_katil', {oda: myRoom, sifre: pass});
        }

        socket.on('oda_katildi', function(data) {
            isHost = data.is_host;
            document.getElementById('display-room').innerText = data.oda;
            showScreen('lobby-screen');
            if(isHost) {
                renderHostCats();
            } else {
                document.getElementById('host-controls').style.display = "none";
                document.getElementById('guest-wait').style.display = "block";
            }
        });

        socket.on('hata', data => alert(data.mesaj));

        // Kategori Yönetimi
        function renderHostCats() {
            const div = document.getElementById('cat-list');
            div.innerHTML = "";
            allCats.forEach(c => {
                div.innerHTML += `<label><input type="checkbox" class="c-box" value="${c}" onchange="syncCats()"> ${c}</label> `;
            });
        }

        function syncCats() {
            let selected = Array.from(document.querySelectorAll('.c-box:checked')).map(b => b.value);
            socket.emit('kategori_degistir', {oda: myRoom, kategoriler: selected});
        }

        socket.on('kategorileri_guncelle', data => {
            activeCats = data.kategoriler;
            if(!isHost) document.getElementById('guest-cat-display').innerText = "Kategoriler: " + activeCats.join(", ");
        });

        // Oyun Akışı
        function oyunuBaslat() { socket.emit('oyunu_baslat', {oda: myRoom}); }
        
        socket.on('yeni_oyun_basladi', data => {
            activeCats = data.kategoriler;
            document.getElementById('harf-alani').innerText = data.harf;
            const area = document.getElementById('input-area');
            area.innerHTML = "";
            activeCats.forEach(c => {
                area.innerHTML += `<div><label>${c}:</label><br><input type="text" class="game-in"></div>`;
            });
            showScreen('game-screen');
            document.getElementById('bitir-btn').disabled = false;
        });

        function bitirSinyali() { socket.emit('oyunu_bitir', {oda: myRoom}); }

        socket.on('geri_sayim_baslat', data => {
            let sec = data.sure;
            const s = document.getElementById('sayac');
            s.style.display = "block";
            let timer = setInterval(() => {
                sec--;
                s.innerText = "SÜRE: " + sec;
                if(sec <= 0) {
                    clearInterval(timer);
                    s.style.display = "none";
                    forceStop();
                }
            }, 1000);
        });

        function forceStop() {
            const ins = document.querySelectorAll('.game-in');
            let myAnswers = {};
            activeCats.forEach((c, i) => {
                myAnswers[c] = ins[i].value;
                ins[i].disabled = true;
            });
            document.getElementById('bitir-btn').disabled = true;
            socket.emit('cevaplari_gonder', {oda: myRoom, cevaplar: myAnswers});
        }

        socket.on('puan_durumu', data => {
            let html = "<table><tr><th>Oyuncu</th>";
            activeCats.forEach(c => html += `<th>${c}</th>`);
            html += "<th>Toplam</th></tr>";
            for(let id in data) {
                html += `<tr><td>${id.substring(0,4)}</td>`;
                activeCats.forEach(c => {
                    let d = data[id].detay[c];
                    html += `<td>${d.kelime} (${d.puan})</td>`;
                });
                html += `<td>${data[id].toplam}</td></tr>`;
            }
            html += "</table>";
            document.getElementById('table-area').innerHTML = html;
            showScreen('result-screen');
        });

        function lobiyeDon() { showScreen('lobby-screen'); }
    </script>
</body>
</html>

